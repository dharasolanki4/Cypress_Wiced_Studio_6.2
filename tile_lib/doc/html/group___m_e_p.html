<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Multi-endpoint TOA</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Multi-endpoint TOA</div>  </div>
</div><!--header-->
<div class="contents">
<p>Multi-endpoint TOA (MEP) is a means by which multiple apps from the same phone may communicate with a single Tile device simultaneously. MEP establishes the concept of TOA <em>channels</em>, which are TOA data streams that can be accessed concurrently. A channel is specified by prepending the channel's CID to the TOA message:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">CID  </th><th class="markdownTableHeadNone">TOA message   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">ATT_MTU - 3 - 1 bytes (typically 19 bytes)   </td></tr>
</table>
<h1>Channel types</h1>
<p>There are three types of channel:</p>
<ul>
<li>The connectionless channel: a special channel for unauthenticated traffic.</li>
<li>The broadcast channel: a special channel for one-way communication from the TOA server to all TOA clients which are listening for broadcasts.</li>
<li>Authenticated channels: channels that are allocated to a TOA client and require a message integrity check (MIC) to be appended the TOA message.</li>
</ul>
<h2>Connectionless channel</h2>
<p>Transactions on the connectionless channel have the following format:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">TOA_CONNECTIONLESS_CID  </th><th class="markdownTableHeadNone">Token  </th><th class="markdownTableHeadNone">TOA code  </th><th class="markdownTableHeadNone">TOA Pay   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">4 bytes  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">Up to TOA_MPS bytes   </td></tr>
</table>
<p>The token is a value randomly generated by the TOA client in order to identify the transaction. When the TOA server receives a command on the connectionless channel, it will send a response with the same token as in the command. Example:</p>
<div class="mscgraph">
<img src="msc_inline_mscgraph_3.png" alt="msc_inline_mscgraph_3" border="0" usemap="#msc_inline_mscgraph_3.map"/>
<map name="msc_inline_mscgraph_3.map" id="msc_inline_mscgraph_3.map"></map>
</div>
<h2>Authenticated channels</h2>
<p>Transactions on authenticated channels have the following format:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">CID  </th><th class="markdownTableHeadNone">TOA code  </th><th class="markdownTableHeadNone">TOA payload  </th><th class="markdownTableHeadNone">MIC   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">Up to TOA_MPS bytes  </td><td class="markdownTableBodyNone">4 bytes   </td></tr>
</table>
<h3>Opening an authenticated channel</h3>
<p>To use an authenticated channel, a TOA client must use TOA_CMD_OPEN_CHANNEL on the connectionless channel, generate a session key, and then send the TOA_CMD_READY on the newly allocated channel.</p>
<div class="mscgraph">
<img src="msc_inline_mscgraph_4.png" alt="msc_inline_mscgraph_4" border="0" usemap="#msc_inline_mscgraph_4.map"/>
<map name="msc_inline_mscgraph_4.map" id="msc_inline_mscgraph_4.map"></map>
</div>
<p>(See documentation for each command/response for format of each message).</p>
<h3>Session key generation</h3>
<p>The session key is generated using HMAC-SHA256 with the Tile's authentication key as the key and the message as</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">RandA  </th><th class="markdownTableHeadNone">RandT  </th><th class="markdownTableHeadNone">CID  </th><th class="markdownTableHeadNone">Token from TOA_CMD_OPEN_CHANNEL   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">14 bytes  </td><td class="markdownTableBodyNone">13 bytes  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">4 bytes   </td></tr>
</table>
<p>The session key is the first 16 bytes of the hash.</p>
<h3>MIC generation</h3>
<p>The MIC for authenticated channels is generated using HMAC-SHA256 with the session key as the key. The message to be hashed varies depending on whether the packet originated with the TOA client or server. For a packet sent from the client to the server, the message is</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Nonce A  </th><th class="markdownTableHeadNone">1  </th><th class="markdownTableHeadNone">Text length  </th><th class="markdownTableHeadNone">Text  </th><th class="markdownTableHeadNone">0 &ndash;   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">8 bytes  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">Text length bytes  </td><td class="markdownTableBodyNone">Until message is 32 bytes long   </td></tr>
</table>
<p>and a packet from the server to the client has the message format</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Nonce T  </th><th class="markdownTableHeadNone">0  </th><th class="markdownTableHeadNone">Text length  </th><th class="markdownTableHeadNone">Text  </th><th class="markdownTableHeadNone">0 &ndash;   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">8 bytes  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">Text length bytes  </td><td class="markdownTableBodyNone">Until message is 32 bytes long   </td></tr>
</table>
<p>The MIC is the first four bytes of the hash. The nonce values are simply counters which increment before each MIC is generated. The text is the TOA message, without the CID or the MIC. Example C code for generating the MIC of a message from the TOA client to the TOA server:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> mic_example(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">// Full payload</span></div><div class="line">    uint8_t msg[] = {</div><div class="line">        cid,</div><div class="line">        TOA_CMD_SONG,</div><div class="line">        TOA_SONG_CMD_PLAY,</div><div class="line">        TILE_SONG_FIND,</div><div class="line">        3,               <span class="comment">// Strength 3</span></div><div class="line">        0, 0, 0, 0       <span class="comment">// Space for MIC</span></div><div class="line">    };</div><div class="line"></div><div class="line">    uint8_t hash_message[32] = {0};</div><div class="line"></div><div class="line">    nonceA++;</div><div class="line"></div><div class="line">    memcpy(hash_message, &amp;nonceA, 8);      <span class="comment">// nonceA since packet is from client to server</span></div><div class="line">    hash_message[8] = 1;                   <span class="comment">// 1 since direction is from client to server</span></div><div class="line">    hash_message[9] = <span class="keyword">sizeof</span>(msg) - 1 - 4; <span class="comment">// -1 for CID and -4 for MIC</span></div><div class="line">    memcpy(hash_message + 10, msg + 1, hash_message[9]);</div><div class="line"></div><div class="line">    <span class="comment">// auth_key is 16 bytes, message is 32 bytes, and desired output is 4 bytes</span></div><div class="line">    hmac_sha256(auth_key, 16, hash_message, 32, &amp;msg[<span class="keyword">sizeof</span>(msg)-4], 4);</div><div class="line">}</div></div><!-- fragment --><h3>Closing a channel</h3>
<p>TOA clients and servers may close a channel at any time using TOA_CMD_CLOSE_CHANNEL and TOA_RSP_CLOSE_CHANNEL, respecitvely. Format for a close channel message:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">CID  </th><th class="markdownTableHeadNone">TOA_CMD/RSP_CLOSE_CHANNEL  </th><th class="markdownTableHeadNone">TOA_CHANNEL_CLOSE_REASONS code  </th><th class="markdownTableHeadNone">Payload  </th><th class="markdownTableHeadNone">MIC   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">Varies  </td><td class="markdownTableBodyNone">4 bytes   </td></tr>
</table>
<p>There are certain behaviors expected of a close channel request.</p>
<ol type="1">
<li>The sender and recipient of a close channel command/response must immediately close the channel and not send any further data over the channel.</li>
<li>The close channel command/response must contain a reason code and the payload must conform to the format specified for that particular reason code.</li>
<li>The close channel response may be sent over the broadcast CID, and in this case, all clients must close their open channels.</li>
</ol>
<h2>Broadcast channel</h2>
<p>Transactions on the broadcast channel have the following format:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">TOA_BROADCAST_CID  </th><th class="markdownTableHeadNone">TOA code  </th><th class="markdownTableHeadNone">TOA payload  </th><th class="markdownTableHeadNone">MIC   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">Up to TOA_MPS bytes  </td><td class="markdownTableBodyNone">4 bytes   </td></tr>
</table>
<h3>Broadcast key generation</h3>
<p>The broadcast key is generated using HMAC-SHA256 with the Tile's authentication key as the key and the message as</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">RandT[0:9]  </th><th class="markdownTableHeadNone">Tile ID  </th><th class="markdownTableHeadNone">0 -&mdash;   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">10 bytes  </td><td class="markdownTableBodyNone">8 bytes  </td><td class="markdownTableBodyNone">14 bytes   </td></tr>
</table>
<p>where RandT[0:9] is the first 10 bytes of the RandT value received in the TOA_RSP_OPEN_CHANNEL. The broadcast key is the first 16 bytes of the hash.</p>
<h3>Broadcast MIC generation</h3>
<p>The MIC for the broadcast channel is generated using HMAC-SHA256 with the broadcast key as the key. The message to be hashed is</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Nonce B  </th><th class="markdownTableHeadNone">Text length  </th><th class="markdownTableHeadNone">Text  </th><th class="markdownTableHeadNone">0 &ndash;   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">8 bytes  </td><td class="markdownTableBodyNone">1 byte  </td><td class="markdownTableBodyNone">Text length bytes  </td><td class="markdownTableBodyNone">Until message is 32 bytes long   </td></tr>
</table>
<p>The MIC is the first four bytes of the hash. The nonce value is simply a counter which increments before each MIC is generated. The TOA_RSP_READY message includes the current value of NonceB. </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
